# Redis Persistency



## 영속성

- Redis는 서버에 장애가 발생했을때를 대비해서 데이터를 RAM, flash memory 조합으로 저장한다.
- 영속 설정이 있는데 내구성을 높이려면 그만큼 성능을 희생해야 하기 때문에 내구성과 성능 사이에 타협점을 찾는게 중요하다.



## 제공 방법

Redis에서는 영속성을 보장하기 위해 크게 2가지 방법을 제공한다.

1. RDB (Redis DataBase), Snapshot 방식
2. AOF (Append-Only File)

- RDB와 AOF를 조합해서 영속성을 보장하는데 RDB, RDB+AOF, AOF, None 총 4가지 세팅이 가능하다.

- 기본으로 AOF는 비활성화이고 RDB는 아래와 같은 기본값이 존재한다.

  - 1시간 내에 최소 하나 이상의 키가 변경되는 경우
  - 5분 내에 최소 100개 이상의 키가 변경되는 경우
  - 1분 내에 최소 10000개 이상의 키가 변경되는 경우

  → 짧은 시간에 키가 많이 변경되면 유실 위험성이 커지기 때문에 이렇게 세팅됨.

- AOF는 Redis에 쓰기 작업을 하면 AOF 파일에 데이터를 차례로 기록한다. 이를 기반으로 재시작할 때 로그 파일 데이터를 재생하는 방식으로 복원한다.



## RDB (SnapShot)

- 특정 시점의 데이터베이스 내에 있는 내용을 RDB라는 형식의 파일로 저장한다.
- 자동(BGSAVE), 수동(SAVE) 설정이 가능하다.

### 동작

1. BGSAVE의 경우 RDB 파일 dump를 위한 자식 프로세스를 fork()해서 생성한 후 dump 처리한다.

2. 이 때 자식 프로세스는 CoW 메커니즘을 활용한다. 즉 자식 프로세스가 쓰기 작업을 수행할 때 내용 차이가 발생하는 경우 그 차이만큼 메모리 영역을 추가로 사용하게 된다.

   → 현재 메모리 사용률을 잘 확인해야 한다. (절반 이상 확보하는 것이 좋다.)

### 주의사항

- Redis는 싱글 스레드로 명령어를 처리하기 때문에 SAVE를 사용하면 dump 도중에 다른 요청을 처리할 수 없기에 운영 환경에서 권장되지 않는다.
- RDB 파일을 압축해서 저장할 수 있는데 CPU 사용률이 증가하기 때문에 잘 따져보고 사용해야 한다.
- 백그라운드 스냅숏 저장에 실패하면 Redis는 기본적으로 쓰기를 허용하지 않는다. (데이터 손실 최소화)



## AOF (Append Only File)

- 쓰기를 할 때마다 뒤에 추가하는 방식으로 동작하기 때문에 내구성이 높다.

  - RDB는 특정 시점의 Snapshot을 뜨는 것이기 때문에 마지막 Snapshot 이후는 손실될 수 있다.

- 파일 끝에 계속 추가하는 방식이기 때문에 RDB 파일보다 일반적으로 크다.

  - 마지막 데이터만 저장하는 RDB에 비해 모든 실행 명령어를 저장하는 AOF가 더 클 수 밖에 없다.

  → 재생해서 메모리에 적재하는 시간이 상대적으로 크다.

- Redis 서버는 명령어를 파일에 기록하기 위해 파일을 버퍼에 유지하는데 이를 AOF 버퍼라고 한다.

- AOF는 fsync로 디스크에 쓰기 작업을 수행하고 appendfsync 지시자로 3가지 자동 생성(수동 불가)을 제공한다.

  1. always (쓰기 작업마다 데이터를 버퍼에서 디스크로 플러시)
  2. everysec (백그라운드 스레드를 생성하여 매초마다 버퍼에서 디스크로 데이터 플러시), 기본값
  3. no (os가 설정한 값으로 실행)

  → 위 설정은 도메인에 따라 적절하게 선택

### 동작

1. 요청 처리 중인 프로세스에서 AOF 파일을 작성하기 위해 자식 프로세스를 포크해서 생성한다.
2. 자식 프로세스는 새로운 AOF 파일을 생성하고 재작성 결과를 저장한다.
3. 자식 프로세스가 새로운 AOF 파일의 재작성을 완료하면 부모 프로세스에 신호를 보낸다.
4. 신호를 받은 부모 프로세스는 포크 이후의 쓰기 작업을 AOF 재작성 버퍼에 저장해두었다가 이를 자식 프로세스에 전송한다. 자식 프로세스는 이 데이터 차이를 새롭게 생성한 AOF 파일에 반영한다.
5. 오래된 AOF 파일을 새로운 AOF 파일로 대체한다.

- RDB와 마찬가지로 CoW 방식을 사용한다.
- AOF 재작성 과정에서 문제가 생겨도 복구할 수 있도록 기존의 AOF 파일에도 지속적으로 쓰기 명령어가 추가된다.



## 영속성 전략

- 영속성 선택을 할때는 데이터의 유실이 얼마나 허용되는지와 성능이 얼마나 나와야 하는지를 고려해야 한다.
- 성능과 내구성은 항상 Trade-off 관계이기 때문에 도메인에 맞게 판단해야 한다.
- 더 높은 가용성이 필요하면 Replication을 활용하면 좋다.



## Active-Active 데이터 영속성

- Active-Active 에서는 AOF 만 지원하고 RDB는 지원하지 않는다.